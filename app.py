import sys # System-specific parameters and functions
import easyocr as ocr  # OCR
import streamlit as st  # web app
from streamlit import cli as stcli # cli web app
from PIL import Image  # opening images
import numpy as np  # for array conversions


st.set_page_config(
    page_title="–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ",
    page_icon="üîç",
    layout="wide",
    menu_items={
         'Get Help': None,
         'Report a bug': None,
         
         'About': "# –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ 83 —è–∑—ã–∫–∞—Ö –º–∏—Ä–∞. –°–æ–∑–¥–∞–Ω–æ –≤ –†–æ—Å—Å–∏–∏, —Å—Ç—É–¥–µ–Ω—Ç–æ–º –°–†–ö–í–¢–∏–≠, –≥—Ä—É–ø–ø–∞ 41/1, –ë–æ–≥–æ—Å–ª–∞–≤—Ü–µ–≤ –î–∞–Ω–∏–ª–∞."
    }
)


@st.cache
def load_model(lang):
    return ocr.Reader([lang], model_storage_directory=".")


def main():
    st.title("üîç–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è")
    st.write("–î–ª—è –æ–ø—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Å–∏–º–≤–æ–ª–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞ –≤ –ª–µ–≤–æ–π —á–∞—Å—Ç–∏ —è–∑—ã–∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—É—é—â–∏–π —è–∑—ã–∫—É —Ç–µ–∫—Å—Ç–∞")
    image = st.file_uploader(
        label="–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ", type=["png", "jpg", "jpeg"]
    )


    langs = {
        "–ê–±–∞–∑–∏–Ω—Å–∫–∏–π": "abq",
        "–ê–¥—ã–≥–µ–π—Å–∫–∏–π": "ady",
        "–ê—Ñ—Ä–∏–∫–∞–∞–Ω—Å": "af",
        "–ê–Ω–≥–∏–∫–∞": "ang",
        "–ê—Ä–∞–±—Å–∫–∏–π": "ar",
        "–ê—Å—Å–∞–º—Å–∫–∏–π": "as",
        "–ê–≤–∞—Ä—Å–∫–∏–π": "ava",
        "–ê–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω—Å–∫–∏–π": "az",
        "–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π": "be",
        "–ë–æ–ª–≥–∞—Ä—Å–∫–∏–π": "bg",
        "–ë–∏—Ö–∞—Ä—Å–∫–∏–π": "bh",
        "–ë—Ö–æ–¥–∂–ø—É—Ä–∏": "bho",
        "–ë–µ–Ω–≥–∞–ª—å—Å–∫–∏–π": "bn",
        "–ë–æ—Å–Ω–∏–π—Å–∫–∏–π": "bs",
        "–£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –ö–∏—Ç–∞–π—Å–∫–∏–π": "ch_sim",
        "–¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–π –ö–∏—Ç–∞–π—Å–∫–∏–π": "ch_tra",
        "–ß–µ—á–µ–Ω—Å–∫–∏–π": "che",
        "–ß–µ—à—Å–∫–∏–π": "cs",
        "–í–∞–ª–ª–∏–π—Å–∫–∏–π": "cy",
        "–î–∞—Ç—Å–∫–∏–π": "da",
        "–î–∞—Ä–≥–∏–Ω—Å–∫–∏–π": "dar",
        "–ù–µ–º–µ—Ü–∫–∏–π": "de",
        "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π": "en",
        "–ò—Å–ø–∞–Ω—Å–∫–∏–π": "es",
        "–≠—Å—Ç–æ–Ω—Å–∫–∏–π": "et",
        "–ü–µ—Ä—Å–∏–¥—Å–∫–∏–π": "fa",
        "–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π": "fr",
        "–ò—Ä–ª–∞–Ω–¥—Å–∫–∏–π": "ga",
        "–ö–æ–Ω–∫–∞–Ω–∏": "gom",
        "–•–∏–Ω–¥–∏": "hi",
        "–•–æ—Ä–≤–∞—Ç—Å–∫–∏–π": "hr",
        "–í–µ–Ω–≥–µ—Ä—Å–∫–∏–π": "hu",
        "–ò–Ω–¥–æ–Ω–µ–∑–∏–π—Å–∫–∏–π": "id",
        "–ò–Ω–≥—É—à—Å–∫–∏–π": "inh",
        "–ò—Å–ª–∞–Ω–¥—Å–∫–∏–π": "is",
        "–ò—Ç–∞–ª—å—è–Ω—Å–∫–∏–π": "it",
        "–Ø–ø–æ–Ω—Å–∫–∏–π": "ja",
        "–ö–∞–±–∞—Ä–¥–∏–Ω–æ-—á–µ—Ä–∫–µ—Å—Å–∫–∏–π": "kbd",
        "–ö–∞–Ω–Ω–∞–¥–∞": "kn",
        "–ö–æ—Ä–µ–π—Å–∫–∏–π": "ko",
        "–ö—É—Ä–¥—Å–∫–∏–π": "ku",
        "–õ–∞—Ç–∏–Ω—Å–∫–∏–π": "la",
        "–õ–∞–∫—Å–∫–∏–π": "lbe",
        "–õ–µ–∑–≥–∏–Ω—Å–∫–∏–π": "lez",
        "–õ–∏—Ç–æ–≤—Å–∫–∏–π ": "lt",
        "–õ–∞—Ç—ã—à—Å–∫–∏–π": "lv",
        "–ú–∞–≥–∞—Ö–∏": "mah",
        "–ú–∞–π—Ç—Ö–∏–ª–∏": "mai",
        "–ú–∞–æ—Ä–∏": "mi",
        "–ú–æ–Ω–≥–æ–ª—å—Å–∫–∏–π": "mn",
        "–ú–∞—Ä–∞—Ç—Ö–∏": "mr",
        "–ú–∞–ª–∞–π—Å–∫–∏–π": "ms",
        "–ú–∞–ª—å—Ç–∏–π—Å–∫–∏–π": "mt",
        "–ù–µ–ø–∞–ª—å—Å–∫–∏–π": "ne",
        "–ù–µ–≤–∞—Ä—Å–∫–∏–π": "new",
        "–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—Å–∫–∏–π": "nl",
        "–ù–æ—Ä–≤–µ–∂—Å–∫–∏–π": "no",
        "–û–∫—Å–∏—Ç–∞–Ω—Å–∫–∏–π": "oc",
        "–ü–∞–ª–∏": "pi",
        "–ü–æ–ª—å—Å–∫–∏–π": "pl",
        "–ü–æ—Ä—Ç—É–≥–∞–ª—å—Å–∫–∏–π": "pt",
        "–†—É–º—ã–Ω—Å–∫–∏–π": "ro",
        "–†—É—Å—Å–∫–∏–π ": "ru",
        "–°–µ—Ä–±—Å–∫–∏–π (–∫–∏—Ä–∏–ª–ª–∏—Ü–∞)": "rs_cyrillic",
        "–°–µ—Ä–±—Å–∫–∏–π (–ª–∞—Ç–∏–Ω–∏—Ü–∞)": "rs_latin",
        "–°–∞–¥—Ä–∏ (–ù–∞–≥–ø—É—Ä–∏)": "sck",
        "–°–ª–æ–≤–∞—Ü–∫–∏–π": "sk",
        "–°–ª–æ–≤–µ–Ω—Å–∫–∏–π": "sl",
        "–ê–ª–±–∞–Ω—Å–∫–∏–π": "sq",
        "–®–≤–µ–¥—Å–∫–∏–π": "sv",
        "–°—É–∞—Ö–∏–ª–∏": "sw",
        "–¢–∞–º–∏–ª—å—Å–∫–∏–π": "ta",
        "–¢–∞–±–∞—Å–∞—Ä–∞–Ω—Å–∫–∏–π": "tab",
        "–¢–µ–ª—É–≥—É": "te",
        "–¢–∞–π—Å–∫–∏–π": "th",
        "–¢–∞–¥–∂–∏–∫—Å–∫–∏–π": "tjk",
        "–¢–∞–≥–∞–ª—å—Å–∫–∏–π": "tl",
        "–¢—É—Ä–µ—Ü–∫–∏–π": "tr",
        "–£–π–≥—É—Ä—Å–∫–∏–π": "ug",
        "–£–∫—Ä–∞–∏–Ω—Å–∫–∏–π": "uk",
        "–£—Ä–¥—É": "ur",
        "–£–∑–±–µ–∫—Å–∫–∏–π": "uz",
        "–í—å–µ—Ç–Ω–∞–º—Å–∫–∏–π": "vi",
    }


    label_langs = st.sidebar.title('üìùüó∫Ô∏è–í—ã–±–æ—Ä —è–∑—ã–∫–∞')
    feature_choice = st.sidebar.selectbox(
        "–£–∫–∞–∂–∏—Ç–µ —è–∑—ã–∫ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è ", list(langs.keys())
    )


    info_text = st.sidebar.text('–î–æ—Å—Ç—É–ø–Ω–æ 83 —è–∑—ã–∫–∞')
    if image is not None:
        input_image = Image.open(image)
        st.image(input_image)
        reader = load_model(lang=langs.get(feature_choice))
        with st.spinner("ü§ñ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ... "):
            result = reader.readtext(
                np.array(input_image)
            )
            out_str = " "
            list_text = [ftext[1] for ftext in result]
            st.title("–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:")
            with open(".txt", 'w') as file:
                file.write(out_str.join(list_text))
            result_file = open(".txt", 'r')
            st.download_button('–°–∫–∞—á–∞—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç', result_file)

            st.title("–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –≤–∏–¥–µ —Ç–µ–∫—Å—Ç–∞:")

  
            futext = st.write(out_str.join(list_text))
            st.title("–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–∫–∞:")
            result_text = [text[1] for text in result]
            st.write(result_text)
    else:
        st.info(
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–µ—Ç–µ —è–∑—ã–∫ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è..."
        )
    st.caption("Made in Russia with ‚ù§Ô∏è by Bogoslavtsev")


if __name__ == "__main__":
    if st._is_running_with_streamlit:
        main()
    else:
        sys.argv = ["streamlit", "run", sys.argv[0]]
        sys.exit(stcli.main())
